services:
  # Kafka & Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Llama Local Model Server (Ollama)
  # GPU support: see Devtools/enable_gpu.sh for setup instructions
  ollama:
    image: ollama/ollama:latest
    container_name: ollama-server
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD-SHELL", "ollama list || exit 0"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 30s
    # GPU SUPPORT ENABLED
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - NVIDIA_VISIBLE_DEVICES=all

  # Prompt Analyser Service
  prompt-analyser:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: prompt-analyser
    command: python -m src.services.prompt_analyser.main
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LLAMA_API_URL=http://ollama:11434
      - SERVICE_NAME=prompt-analyser
    depends_on:
      kafka:
        condition: service_healthy
      ollama:
        condition: service_healthy
    volumes:
      - ./src:/app/src
      - ./workspace:/workspace
    networks:
      - agentic-network

  # Message Bus Service
  message-bus:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: message-bus
    command: python -m src.services.message_bus.main
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - SERVICE_NAME=message-bus
    depends_on:
      kafka:
        condition: service_healthy
    volumes:
      - ./src:/app/src
    networks:
      - agentic-network

  # Agent: Code Writer
  agent-code-writer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agent-code-writer
    command: python -m src.agents.code_writer.main
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LLAMA_API_URL=http://ollama:11434
      - SERVICE_NAME=agent-code-writer
    depends_on:
      - message-bus
    volumes:
      - ./src:/app/src
      - ./workspace:/workspace
    networks:
      - agentic-network

  # Agent: Architect
  agent-architect:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agent-architect
    command: python -m src.agents.architect.main
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LLAMA_API_URL=http://ollama:11434
      - SERVICE_NAME=agent-architect
    depends_on:
      - message-bus
    volumes:
      - ./src:/app/src
      - ./workspace:/workspace
    networks:
      - agentic-network

  # Agent: Code Quality Analyser
  agent-code-quality:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agent-code-quality
    command: python -m src.agents.code_quality.main
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LLAMA_API_URL=http://ollama:11434
      - SERVICE_NAME=agent-code-quality
    depends_on:
      - message-bus
    volumes:
      - ./src:/app/src
      - ./workspace:/workspace
    networks:
      - agentic-network

  # Agent: Tester WhiteBox
  agent-tester-whitebox:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agent-tester-whitebox
    command: python -m src.agents.tester_whitebox.main
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LLAMA_API_URL=http://ollama:11434
      - SERVICE_NAME=agent-tester-whitebox
    depends_on:
      - message-bus
    volumes:
      - ./src:/app/src
      - ./workspace:/workspace
    networks:
      - agentic-network

  # Agent: Tester BlackBox
  agent-tester-blackbox:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agent-tester-blackbox
    command: python -m src.agents.tester_blackbox.main
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LLAMA_API_URL=http://ollama:11434
      - SERVICE_NAME=agent-tester-blackbox
    depends_on:
      - message-bus
    volumes:
      - ./src:/app/src
      - ./workspace:/workspace
    networks:
      - agentic-network

  # Agent: CI/CD
  agent-cicd:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agent-cicd
    command: python -m src.agents.cicd.main
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LLAMA_API_URL=http://ollama:11434
      - SERVICE_NAME=agent-cicd
    depends_on:
      - message-bus
    volumes:
      - ./src:/app/src
      - ./workspace:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - agentic-network

  # VSCode Interface API
  vscode-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vscode-api
    command: python -m src.api.main
    ports:
      - "8000:8000"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LLAMA_API_URL=http://ollama:11434
      - SERVICE_NAME=vscode-api
    depends_on:
      kafka:
        condition: service_healthy
      ollama:
        condition: service_healthy
    volumes:
      - ./src:/app/src
      - ./workspace:/workspace
    networks:
      - agentic-network

networks:
  agentic-network:
    driver: bridge

volumes:
  ollama-data:
  workspace:
